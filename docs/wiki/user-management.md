# کارهای مرتبط با ساخت و مدیریت کاربر در بک‌اند

این بخش توضیح می‌دهد بک‌اند هنگام ایجاد یا ویرایش کاربر چه کارهایی انجام می‌دهد و چطور می‌توانید از endpointها استفاده کنید.

## رفتار سرویس در ایجاد/ویرایش کاربر
- **حذف کامل نام کاربری**: ورود/مدیریت حساب صرفاً ایمیل‌محور است و فیلد `username` دیگر پذیرفته یا ذخیره نمی‌شود.
- **نقش الزامی در ساخت ادمین/کاربر مدیریتی**: در Endpointهای مدیریتی، نقش باید صراحتاً ارسال شود؛ مقادیر نامعتبر یا فقدان نقش باعث خطای `400 Bad Request` می‌شود.
- **مجوزها و وضعیت فعال**: مجوزها فقط برای نقش `ADMIN` اعمال می‌شوند و برای سایر نقش‌ها پاک می‌شوند؛ اگر مقدار `active` ارسال نشود کاربر به طور پیش‌فرض فعال است. ادمین‌هایی که با دعوت‌نامه ساخته می‌شوند ابتدا در وضعیت `INVITED` قرار می‌گیرند و تا زمانی که دعوت پذیرفته نشود، فعال نیستند.
- **به‌روزرسانی ایمن**: هر فیلد فقط در صورت ارسال مقدار جدید تغییر می‌کند؛ تغییر ایمیل دوباره نرمال‌سازی و کنترل یکتا بودن را طی می‌کند و رمز عبور تنها در صورت مقدار غیرخالی جدید هش می‌شود.
- **عدم دسترسی عمومی به فهرست کاربران**: دسترسی به `GET /api/users` و `GET /api/users/{id}` فقط برای `SUPER_ADMIN` یا ادمین دارای مجوز `MANAGE_USERS` مجاز است؛ سایر نقش‌ها پاسخ `403 Forbidden` می‌گیرند. هدر احراز هویت نامعتبر یا غایب باعث `401 Unauthorized` می‌شود.
- **حوزهٔ نقش‌ها**: نقش‌های پشتیبانی‌شده شامل `SUPER_ADMIN`، `ADMIN`، `WORKER` و `CUSTOMER` هستند. نقش `SUPER_ADMIN` فقط برای مدیریت ادمین‌ها و دیدن فهرست کاربران استفاده می‌شود و برای عملیات روزمره (سفارش/محصول) لازم نیست.
- **ممانعت از ایجاد SUPER_ADMIN از طریق API**: هیچ Endpoint عمومی یا مدیریتی اجازهٔ ایجاد یا ارتقا به `SUPER_ADMIN` را ندارد؛ درخواست‌هایی که نقش را به `SUPER_ADMIN` تنظیم کنند با خطای `400/403` رد می‌شوند. تنها راه مجاز برای ایجاد اولین سوپرادمین، اسکریپت/مهاجرت داخلیِ سمت سرور است که دسترسی عمومی ندارد. تنها سوپرادمین می‌تواند ادمین بسازد و آن هم صرفاً از مسیر دعوت‌نامه.
- **پیکربندی سوپرادمین اولیه**: در راه‌اندازی برنامه، اگر هیچ کاربری با نقش `SUPER_ADMIN` وجود نداشته باشد، بک‌اند از مقادیر پیکربندی (`APP_SUPERADMIN_EMAIL` و `APP_SUPERADMIN_PASSWORD`) یک حساب اولیه با نام نمایشی `APP_SUPERADMIN_DISPLAY_NAME` (پیش‌فرض: «Super Admin») و وضعیت `APP_SUPERADMIN_ACTIVE` (پیش‌فرض: true) می‌سازد؛ در صورت نبود این مقادیر، عملیات نادیده گرفته می‌شود. هیچ حساب دیگری (ADMIN/WORKER/CUSTOMER) به‌صورت خودکار ساخته نمی‌شود؛ برای محیط توسعه می‌توان بذر آزمایشی را فقط با فعال‌کردن `app.demo-seed.enabled=true` روشن کرد.
- **ورود کاربران غیرفعال مسدود است**: اگر `active=false` باشد، ورود در `POST /api/auth/login` با وضعیت `403 Forbidden` رد می‌شود و توکنی صادر نمی‌شود.

## Endpointهای مربوط به کاربر
- `POST /api/auth/login` برای دریافت توکن احراز هویت.
- `GET /api/users` و `GET /api/users/{id}` برای فهرست یا دریافت جزئیات کاربر.
- `POST /api/users` برای ایجاد کاربر جدید (با role و permissions الزامی برای ادمین/سوپرادمین؛ کلاینت عمومی نمی‌تواند نقش را تعیین کند).
- `PUT /api/users/{id}` برای ویرایش کاربر موجود.
- Endpointهای ویژه‌ی سوپر ادمین برای مدیریت چرخهٔ حیات ادمین‌ها:
  - `GET /api/super-admin/admins` برای فهرست‌کردن ادمین‌ها همراه با وضعیت (`INVITED`/`ACTIVE`/`DISABLED`) و مجوزها.
  - `POST /api/super-admin/admins/invite` برای ارسال دعوت‌نامه ادمین (توکن دعوت فقط به‌صورت هش ذخیره می‌شود و در پاسخ بازگردانده نمی‌شود).
  - `POST /api/super-admin/admins/{id}/resend-invite` برای ارسال مجدد دعوت در صورت بازهٔ اعتبار.
  - `PUT /api/super-admin/admins/{id}/permissions` برای تنظیم مجوزهای ادمین.
  - `PUT /api/super-admin/admins/{id}/status` برای فعال/غیرفعال کردن ادمین.
  - `DELETE /api/super-admin/admins/{id}` برای حذف کامل ادمین.
- Endpoint عمومی برای پذیرش دعوت‌نامه ادمین:
  - `POST /api/auth/accept-invite` با بدنهٔ `{ token, password }` که پس از اعتبارسنجی توکن، حساب را فعال و رمز را هش می‌کند.

> نکته: برای endpointهای ادمین/سوپرادمین، هدر `Authorization` را با توکن ورود ارسال کنید.

## کالکشن آماده برای Bruno
فایل [`postman/nft-backend.bru`](../../postman/nft-backend.bru) تمام endpointها (به‌همراه نمونه بدنه) را در قالب Bruno قرار می‌دهد. پیش از اجرا مقدار `baseUrl` و `authToken` را در محیط `local` به مقدار مناسب تغییر دهید.
